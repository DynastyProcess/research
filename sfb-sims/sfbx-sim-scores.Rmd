---
title: "SFBX Sim Scores"
author: "Tan Ho"
date: "`r Sys.Date()`"
output:
  html_notebook:
    code: hide
  html_document:
    df_print: paged
---

This notebook details research on SFBX Similarity Scores, by Tan Ho. 


# Libraries

```{r setup, include=FALSE}

# Data Import
library(ffscrapr) # github: dynastyprocess/ffscrapr
library(arrow)

# Data Manipulation
library(tidyverse) 

# Modelling
library(tidymodels)
library(tidytext)
library(bbplot)

# Report
library(knitr)
library(rmarkdown)
library(DT)

options(dplyr.summarise.inform = FALSE)

knitr::opts_chunk$set(echo = TRUE)

windowsFonts("Fira Sans Condensed" = windowsFont("Fira Sans Condensed"))

```

# Data Import

```{r echo = TRUE}

base_conn <- mfl_connect(2020,
                         rate_limit_number = 2,
                         rate_limit_seconds = 3,
                         user_agent = "dynastyprocess/script")

sfb_leagues <- mfl_getendpoint(base_conn,
                               endpoint = "leagueSearch", 
                               SEARCH = "#SFBX Conference") %>%
  pluck("content","leagues","league") %>%
  tibble() %>%
  unnest_wider(1) %>%
  mutate(conn = map(id,~mfl_connect(2020,
                                    .x,
                                    rate_limit_number = 6,
                                    rate_limit_seconds = 10,
                                    user_agent = "dynastyprocess/script")))

raw_sfbpicks <- map_dfr(sfb_leagues$conn,ff_draft)

df_sfbpicks <- raw_sfbpicks %>% 
  filter(!is.na(player_name)) %>%
  group_by(division_name,pos) %>%
  mutate(pos_adp = row_number()) %>%
  ungroup() %>%
  group_by(player_id,player_name,pos,team,age) %>%
  mutate(pos_adp = mean(pos_adp,na.rm = TRUE),
         count = n()) %>%
  ungroup() %>%
  group_by(franchise_name,pos) %>%
  mutate(pos_slot = rank(pos_adp)) %>%
  ungroup()

df_sfbpicks %>%
  select(division_name,franchise_name,player_id,player_name,pos,age,team,pos_adp,pos_slot) %>% 
  write_parquet("data/sfb_picks.pdata")

```

## Player Similarity Score

Improving on the standard "how many matches do you have" by weighting the positional adp with an exponential decay model (a-la-DynastyProcess trade values). Not perfect, but helps float the important matches up to the top.


```{r echo = TRUE}
user <- "TanHo"

user_picks <- df_sfbpicks %>%
  filter(str_detect(franchise_name,user) & !is.na(player_name))

simscores_player <- df_sfbpicks %>%
  mutate(sim_score = 1000*exp(-0.02 * pos_adp)) %>%
  select(timestamp,division_name,round,pick,franchise_name,player_id,player_name,pos,age,team,pos_adp,count,sim_score) %>%
  semi_join(user_picks,by = c('player_id')) %>%
  group_by(franchise_name) %>%
  summarise(total_sim_score = sum(sim_score,na.rm=TRUE),
            matching_count = n(),
            matching_players = paste(player_name,collapse = " | ")) %>%
  arrange(desc(total_sim_score))

head(simscores_player) %>% 
  datatable()

```
# Strategic Similarity

Tired: player similarity scores (or at least, already been done many times!)
Wired: strategic similarity - what pos adp did they take each slot of their roster?

Cleaning up to show positional adp for QB/TE 1-2 + RB/WR 1-4 in wide format, which will help with PCA-analysis of strategy

[Why positional adp? Divisions were all over the place in terms of ADP, but positional adp are normalized across divisions]

### Cleanup

``` {r}
posadp_wide <- df_sfbpicks %>%
  select(division_name,franchise_name,pos,pos_slot,pos_adp) %>%
  mutate(pos = fct_relevel(pos,c("QB","RB","WR","TE"))) %>%
  arrange(franchise_name,pos,pos_slot) %>%
  filter((pos %in% c("QB","TE") & pos_slot <=3) | (pos %in% c("RB","WR") & pos_slot <=5)) %>%
  pivot_wider(names_from = c(pos,pos_slot),
              names_sep = "",
              # values_fill = 100, # if they haven't taken one of these slots, assume posadp of 100
              values_from = pos_adp) %>%
  mutate(across(c(starts_with("QB"),starts_with("TE")),replace_na,50),
         across(c(starts_with("RB"),starts_with("WR")),replace_na,100)) %>% 
  select(division_name,
         franchise_name,
         starts_with("QB"),
         starts_with("RB"),
         starts_with("WR"),
         starts_with("TE"))

```

### PCA
(borrowed liberally from Julia Silge's https://juliasilge.com/blog/cocktail-recipes-umap/ guide)

```{r}
pca_rec <- recipe(~.,data = posadp_wide) %>%
  update_role(division_name,franchise_name, new_role = "id") %>%
  step_normalize(all_predictors()) %>%
  step_pca(all_predictors(),threshold = 0.8) # "Give me enough PCs to explain 80% of variance"

pca_prep <- prep(pca_rec)

tidied_pca <- tidy(pca_prep,2)

pca_varexplained <- pca_prep %>%
  pluck("steps",2,"res","sdev") %>%
  as_tibble_col("sdev") %>%
  mutate(component = unique(tidied_pca$component),
         percent_var = sdev^2/sum(sdev^2),
         cumulative_var = cumsum(percent_var)) %>% 
  select(component,sdev,percent_var,cumulative_var)

pca_varexplained

```

```{r}
# tidied_pca %>%
#   filter(component %in% paste0("PC",1:8)) %>%
#   mutate(component = fct_inorder(component)) %>%
#   ggplot(aes(value,terms, fill = terms)) +
#   geom_col(show.legend = FALSE) +
#   facet_wrap(~component,nrow = 2) +
#   hrbrthemes::theme_modern_rc(base_family = "Fira Sans Condensed") +
#   theme(strip.text = element_text(colour = "white"))+
#   labs(y = NULL)

pca_factors <- tidied_pca %>%
  filter(component %in% paste0("PC", 1:6)) %>%
  group_by(component) %>%
  top_n(8, abs(value)) %>%
  ungroup() %>%
  mutate(terms = reorder_within(terms, abs(value), component))

write_parquet(pca_factors,"data/pca_factors.pdata")

plot_pcafactors <- pca_factors %>% 
  ggplot(aes(abs(value), terms, fill = ifelse(value > 0,"Late","Early"))) +
  geom_col() +
  facet_wrap(~component, scales = "free_y") +
  scale_y_reordered() +
  labs(
    title = "SFBX Strategic Spectrums",
    subtitle = "Important Factors for each Principal Component",
    x = "Importance of Factor to PC Score",
    y = NULL, fill = "Early or Late Pos ADP"
  ) +
  hrbrthemes::theme_modern_rc(base_family = "Fira Sans Condensed") +
  theme(strip.text = element_text(colour = "white")) +
  theme(legend.position = "bottom") 

plot_pcafactors

ggsave("pca_factors.png",plot_pcafactors,dpi = 320,width = 7,height = 7)

```

```{r}
pca_juice <- juice(pca_prep)

# juice(pca_prep) %>%
#   # filter(abs(PC1)>4& abs(PC2)>2) %>%
#   ggplot(aes(PC3, PC4, label = franchise_name)) +
#   geom_point(aes(color = division_name), alpha = 0.7, size = 2) +
#   geom_text(check_overlap = TRUE, hjust = "inward") +
#   labs(color = NULL) +
#   hrbrthemes::theme_ft_rc(base_family = 'Arial') +
#   theme(legend.position = 'none')

write_parquet(pca_juice,'data/pca_juice.pdata')

```

# Sim Scores
via euclidean distance

```{r}
pca_dist <- pca_juice %>%
  select(-division_name,-franchise_name) %>%
  dist() %>%
  as.matrix(nrow = nrow(pca_juice)) %>%
  as_tibble() %>%
  set_names(pca_juice$franchise_name) %>%
  bind_cols(franchise_name = pca_juice$franchise_name,.)

write_parquet(pca_dist, 'data/pca_dist.pdata')

pca_sims <- pca_dist %>%
  select(franchise_name,contains(user)) %>%
  arrange(across(contains(user)))
```

# Clustering
via k-means

```{r}

df_kmeans <- pca_juice %>%
  select(-division_name,-franchise_name) %>%
  nest(data = everything()) %>%
  crossing(k = 1:16) %>%
  mutate(kclust = map2(data,k,kmeans),
         tidied = map(kclust,tidy),
         glanced = map(kclust,glance),
         augmented = map2(kclust,data,augment))

clusters <- df_kmeans %>%
  unnest(cols = c(tidied))

assignments <- df_kmeans %>%
  unnest(cols = c(augmented))

clusterings <- df_kmeans %>%
  unnest(cols = c(glanced))

p1 <- assignments %>%
  ggplot(aes(x = PC1, y = PC2)) +
  geom_point(aes(color = .cluster), alpha = 0.8) +
  facet_wrap(~ k) +
  theme_minimal()

p1

```

```{r}
ggplot(clusterings, aes(k, tot.withinss)) +
  geom_line() +
  geom_point() +
  labs(title = "How many clusters should we have?",
       subtitle = "Variance within each cluster - decreasing as more clusters are added") +
  hrbrthemes::theme_modern_rc()
```

6 clusters seem to be the point of diminishing returns!


